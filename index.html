<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DG SOCIAL SERVICE - Premium Panel with Complete Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ============================
           DG SOCIAL SERVICE - CSS Styles
           ============================ */
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #0f172a;
            --bg-light: #1e293b;
            --card-bg: rgba(30, 41, 59, 0.8);
            --card-border: rgba(99, 102, 241, 0.2);
            --text: #f1f5f9;
            --text-light: #94a3b8;
            --sidebar-bg: #0f172a;
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
        }

        .glow-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            background: radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.1) 0%, transparent 40%),
                       radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.08) 0%, transparent 40%);
        }

        /* Auth Screen */
        #authBox {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: var(--bg);
        }

        .auth-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 40px 35px;
            width: 100%;
            max-width: 420px;
            text-align: center;
            box-shadow: var(--shadow);
            animation: slideUp 0.5s ease-out;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
            color: var(--primary);
            font-size: 28px;
            font-weight: 700;
        }

        .logo-icon {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .auth-form {
            margin-top: 25px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-light);
            font-size: 14px;
            font-weight: 500;
        }

        .input-field {
            width: 100%;
            padding: 14px 18px;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--text);
            font-size: 15px;
            outline: none;
            transition: var(--transition);
        }

        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-google {
            background: white;
            color: #333;
            margin-top: 10px;
            border: 1px solid #ddd;
        }

        .btn-google:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
        }

        .auth-switch {
            margin-top: 25px;
            color: var(--text-light);
            font-size: 14px;
        }

        .auth-link {
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }

        .auth-link:hover {
            text-decoration: underline;
        }

        /* App Container */
        #app {
            display: none;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .menu-toggle {
            width: 44px;
            height: 44px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
            transition: var(--transition);
        }

        .menu-toggle:hover {
            background: rgba(99, 102, 241, 0.2);
            transform: scale(1.05);
        }

        .menu-toggle span {
            display: block;
            width: 20px;
            height: 2px;
            background: var(--primary);
            border-radius: 10px;
            transition: var(--transition);
        }

        .menu-toggle span:nth-child(2) {
            width: 16px;
            align-self: flex-start;
            margin-left: 2px;
        }

        .wallet-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(79, 70, 229, 0.1));
            padding: 8px 16px;
            border-radius: 12px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .wallet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.2);
        }

        .wallet-icon {
            color: var(--accent);
            font-size: 16px;
        }

        .wallet-balance {
            color: var(--accent);
            font-weight: 700;
            font-size: 16px;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 260px;
            height: 100%;
            background: var(--sidebar-bg);
            border-right: 1px solid rgba(99, 102, 241, 0.1);
            z-index: 1000;
            transition: var(--transition);
            padding: 25px 20px;
            box-shadow: 10px 0 40px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sidebar-logo {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .sidebar-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 12px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .sidebar-user:hover {
            background: rgba(99, 102, 241, 0.15);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            overflow: hidden;
            background: var(--bg-light);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info-sidebar {
            flex: 1;
        }

        .user-name-sidebar {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .user-email-sidebar {
            font-size: 11px;
            color: var(--text-light);
        }

        .sidebar-menu {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .menu-item {
            padding: 12px 14px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-light);
            text-decoration: none;
            font-size: 14px;
        }

        .menu-item:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--text);
            transform: translateX(5px);
        }

        .menu-item.active {
            background: rgba(99, 102, 241, 0.15);
            color: var(--text);
            border-left: 3px solid var(--primary);
            font-weight: 600;
        }

        .menu-item i {
            width: 20px;
            font-size: 16px;
        }

        .menu-item.logout {
            margin-top: 20px;
            color: var(--danger);
            border-left: 3px solid var(--danger);
        }

        /* Main Content */
        .main-content {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 100px;
        }

        .page {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .page.active {
            display: block;
        }

        .page-header {
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .page-title {
            font-size: 26px;
            font-weight: 700;
            color: var(--text);
        }

        .page-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 18px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .card-icon {
            width: 44px;
            height: 44px;
            background: rgba(99, 102, 241, 0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--primary);
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
        }

        /* Order Form */
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-col {
            flex: 1;
        }

        .select-field, .input-field {
            width: 100%;
            padding: 14px 18px;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--text);
            font-size: 15px;
            outline: none;
            transition: var(--transition);
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 18px center;
            background-size: 18px;
            padding-right: 45px;
        }

        .select-field:focus, .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .price-box {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price-label {
            color: var(--text-light);
            font-size: 16px;
        }

        .price-amount {
            color: var(--accent);
            font-weight: 800;
            font-size: 24px;
        }

        /* Support Cards */
        .support-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .support-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            text-decoration: none;
            color: var(--text);
            transition: var(--transition);
        }

        .support-card:hover {
            transform: translateY(-5px);
            background: rgba(99, 102, 241, 0.1);
        }

        .support-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .support-info h4 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .support-info p {
            color: var(--text-light);
            font-size: 14px;
        }

        /* Profile */
        .profile-card {
            text-align: center;
            padding: 30px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid var(--primary);
            margin: 0 auto 20px;
            overflow: hidden;
            background: var(--bg-light);
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .profile-email {
            color: var(--text-light);
            font-size: 16px;
            margin-bottom: 25px;
        }

        /* Admin Panel */
        .admin-section {
            margin-bottom: 30px;
        }

        .admin-user-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info h5 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .user-details {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: var(--text-light);
        }

        .admin-actions {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-sm:hover {
            transform: translateY(-2px);
        }

        .btn-primary-sm {
            background: var(--primary);
            color: white;
        }

        .btn-warning-sm {
            background: var(--warning);
            color: white;
        }

        .btn-success-sm {
            background: var(--accent);
            color: white;
        }

        .btn-danger-sm {
            background: var(--danger);
            color: white;
        }

        .btn-info-sm {
            background: #17a2b8;
            color: white;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            border-top: 1px solid rgba(99, 102, 241, 0.1);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            padding: 5px 15px;
            border-radius: 12px;
        }

        .nav-item:hover {
            color: var(--primary);
        }

        .nav-item.active {
            color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .nav-icon {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .nav-label {
            font-size: 12px;
            font-weight: 600;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Commission Display */
        .commission-display {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .commission-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .commission-label {
            color: var(--text-light);
            font-size: 16px;
        }

        /* Commission Input Box */
        .commission-input-container {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 20px;
        }

        .commission-input-box {
            flex: 1;
        }

        .commission-input {
            width: 100%;
            padding: 16px 20px;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--text);
            font-size: 16px;
            outline: none;
            transition: var(--transition);
        }

        .commission-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .commission-input::placeholder {
            color: var(--text-light);
            opacity: 0.7;
        }

        /* Orders Table */
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .orders-table th {
            background: rgba(99, 102, 241, 0.1);
            padding: 12px;
            text-align: left;
            color: var(--text-light);
            font-weight: 600;
            font-size: 14px;
        }

        .orders-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 14px;
        }

        .status-pending {
            color: var(--warning);
            font-weight: 600;
        }

        .status-completed {
            color: var(--accent);
            font-weight: 600;
        }

        .status-failed {
            color: var(--danger);
            font-weight: 600;
        }

        /* Referral Section */
        .referral-box {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(79, 70, 229, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
        }

        .referral-code {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--primary);
            border-radius: 10px;
            padding: 15px;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 2px;
            margin: 15px 0;
            color: var(--primary);
        }

        /* API Section */
        .api-key-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--accent);
            border-radius: 10px;
            padding: 15px;
            font-family: monospace;
            word-break: break-all;
            margin: 15px 0;
        }

        /* Payment Management Table */
        .payment-filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .payment-filter-controls select,
        .payment-filter-controls input {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .payment-table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .payment-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
        }

        .payment-table th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .payment-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .payment-table tr:hover {
            background: var(--bg-hover);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .payment-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 4px 8px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-action:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .pagination-buttons {
            display: flex;
            gap: 5px;
        }

        .pagination-buttons button {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination-buttons button:hover:not(:disabled) {
            background: var(--primary);
            color: white;
        }

        .pagination-buttons button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .pagination-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            color: var(--text-light);
            font-size: 14px;
        }

        /* Admin Dashboard Tabs */
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .admin-tab {
            padding: 10px 20px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .admin-tab:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .admin-tab.active {
            background: rgba(99, 102, 241, 0.2);
            border-bottom: 2px solid var(--primary);
        }

        /* Admin Content */
        .admin-content {
            display: none;
        }

        .admin-content.active {
            display: block;
        }

        /* Script Management */
        .script-code {
            width: 100%;
            height: 200px;
            background: #1e293b;
            color: white;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            resize: vertical;
        }

        /* Appearance Settings */
        .appearance-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .appearance-option {
            padding: 15px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .appearance-option:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .appearance-option.active {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.15);
        }

        /* Ticket Management */
        .ticket-message {
            background: rgba(30, 41, 59, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .ticket-response {
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid var(--accent);
        }

        /* Service Management */
        .service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .service-details h4 {
            margin-bottom: 5px;
        }

        .service-actions {
            display: flex;
            gap: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .auth-card {
                padding: 30px 25px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .support-grid {
                grid-template-columns: 1fr;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .payment-filter-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .admin-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="glow-effect"></div>

    <!-- Authentication Screen -->
    <div id="authBox">
        <div class="auth-card">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-rocket"></i>
                </div>
                <span>DG SOCIAL SERVICE</span>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" class="input-field">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="loginPass" placeholder="Enter your password" class="input-field">
                </div>
                
                <button class="btn btn-primary" onclick="doLogin()">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
                
                <button class="btn btn-google" onclick="doGoogleAuth()">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" alt="Google">
                    Continue with Google
                </button>
                
                <div class="auth-switch">
                    New to DG Social Service? 
                    <span class="auth-link" onclick="toggleAuth(false)">Create Account</span>
                </div>
            </div>
            
            <!-- Signup Form -->
            <div id="signupForm" class="auth-form" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="signupName" placeholder="Enter your full name" class="input-field">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="signupEmail" placeholder="Enter your email" class="input-field">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="signupPass" placeholder="Create a password (min. 6 characters)" class="input-field">
                </div>
                
                <button class="btn btn-primary" onclick="doSignup()">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>
                
                <button class="btn btn-google" onclick="doGoogleAuth()">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" alt="Google">
                    Sign up with Google
                </button>
                
                <div class="auth-switch">
                    Already have an account? 
                    <span class="auth-link" onclick="toggleAuth(true)">Sign In</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-rocket"></i>
                </div>
                <div class="sidebar-title">DG PANEL</div>
            </div>
            
            <!-- User Profile in Sidebar -->
            <div class="sidebar-user" onclick="openPage('profile')">
                <div class="user-avatar">
                    <img id="sidebarPfp" src="" alt="Profile">
                </div>
                <div class="user-info-sidebar">
                    <div class="user-name-sidebar" id="sidebarName">User</div>
                    <div class="user-email-sidebar" id="sidebarEmail">user@email.com</div>
                </div>
                <i class="fas fa-chevron-right" style="color: var(--text-light); font-size: 12px;"></i>
            </div>
            
            <div class="sidebar-menu">
                <a class="menu-item active" onclick="openPage('home', this)">
                    <i class="fas fa-bolt"></i>
                    <span>New Order</span>
                </a>
                
                <a class="menu-item" onclick="openPage('orders', this)">
                    <i class="fas fa-list"></i>
                    <span>Orders</span>
                </a>
                
                <a class="menu-item" onclick="openPage('refill', this)">
                    <i class="fas fa-history"></i>
                    <span>Refill History</span>
                </a>
                
                <a class="menu-item" onclick="openPage('services', this)">
                    <i class="fas fa-cogs"></i>
                    <span>Services</span>
                </a>
                
                <a class="menu-item" onclick="openPage('addfund', this)">
                    <i class="fas fa-wallet"></i>
                    <span>Deposit</span>
                </a>
                
                <a class="menu-item" onclick="openPage('tickets', this)">
                    <i class="fas fa-ticket-alt"></i>
                    <span>Tickets</span>
                </a>
                
                <a class="menu-item" onclick="openPage('api', this)">
                    <i class="fas fa-code"></i>
                    <span>API</span>
                </a>
                
                <a class="menu-item" onclick="openPage('refer', this)">
                    <i class="fas fa-gift"></i>
                    <span>Refer & Earn</span>
                </a>
                
                <a class="menu-item" onclick="openPage('support', this)">
                    <i class="fas fa-headset"></i>
                    <span>Support</span>
                </a>
                
                <a class="menu-item" onclick="openPage('profile', this)">
                    <i class="fas fa-user-circle"></i>
                    <span>My Profile</span>
                </a>
                
                <!-- ADMIN MENU ITEMS -->
                <a id="adminBtn" class="menu-item" style="display: none; color: #f87171; border-left: 3px solid #f87171;" onclick="openPage('admin', this)">
                    <i class="fas fa-lock"></i>
                    <span>Admin Dashboard</span>
                </a>
                
                <!-- Admin Submenu (only visible when admin is logged in) -->
                <div id="adminSubmenu" style="display: none; padding-left: 20px;">
                    <a class="menu-item" onclick="openAdminTab('adminDashboard', this)">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                    
                    <a class="menu-item" onclick="openAdminTab('adminUsers', this)">
                        <i class="fas fa-users"></i>
                        <span>User Management</span>
                    </a>
                    
                    <a class="menu-item" onclick="openAdminTab('adminServices', this)">
                        <i class="fas fa-cogs"></i>
                        <span>Service Management</span>
                    </a>
                    
                    <a class="menu-item" onclick="openAdminTab('adminOrders', this)">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Orders Management</span>
                    </a>
                    
                    <a class="menu-item" onclick="openAdminTab('adminPayments', this)">
                        <i class="fas fa-rupee-sign"></i>
                        <span>Manual Payments</span>
                    </a>
                    
                    <a class="menu-item" onclick="openAdminTab('adminTickets', this)">
                        <i class="fas fa-ticket-alt"></i>
                        <span>Tickets Management</span>
                    </a>
                    
                    <a class="menu-item" onclick="openAdminTab('adminScripts', this)">
                        <i class="fas fa-code"></i>
                        <span>Script Support</span>
                    </a>
                    
                    <a class="menu-item" onclick="openAdminTab('adminAppearance', this)">
                        <i class="fas fa-paint-brush"></i>
                        <span>Appearance</span>
                    </a>
                    
                    <a class="menu-item" onclick="openAdminTab('adminSettings', this)">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                    
                    <a class="menu-item" onclick="openAdminTab('adminExtra', this)">
                        <i class="fas fa-plus-circle"></i>
                        <span>Extra Menu</span>
                    </a>
                </div>
                
                <a class="menu-item logout" onclick="doLogout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </div>

        <!-- Top Bar -->
        <div class="top-bar">
            <div class="menu-toggle" onclick="toggleSidebar(true)">
                <span></span>
                <span></span>
                <span></span>
            </div>
            
            <div class="wallet-card" onclick="openPage('addfund')">
                <i class="fas fa-wallet wallet-icon"></i>
                <div>
                    <div style="font-size: 11px; color: var(--text-light);">Balance</div>
                    <div class="wallet-balance">₹<span id="balText">0.00</span></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Home Page -->
            <div id="home" class="page active">
                <div class="page-header">
                    <div class="page-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div>
                        <h1 class="page-title">Create New Order</h1>
                        <p style="color: var(--text-light);">Order social media services instantly</p>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <h2 class="card-title">Order Details</h2>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">Category</label>
                            <select id="catSelect" class="select-field" onchange="fetchServicesFromAPI()">
                                <option value="">Select Category ▼</option>
                                <option value="Instagram">Instagram</option>
                                <option value="YouTube">YouTube</option>
                                <option value="Telegram">Telegram</option>
                                <option value="Facebook">Facebook</option>
                                <option value="Twitter">Twitter</option>
                                <option value="TikTok">TikTok</option>
                            </select>
                        </div>
                        
                        <div class="form-col">
                            <label class="form-label">Service</label>
                            <select id="srvSelect" class="select-field" onchange="calculateAutoPrice()">
                                <option value="">Choose Service ▼</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Link / Username</label>
                        <input type="text" id="orderLink" placeholder="Paste your profile or post link" class="input-field">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Quantity</label>
                        <input type="number" id="orderQty" value="100" min="10" step="10" class="input-field" oninput="calculateAutoPrice()">
                    </div>
                    
                    <div class="price-box">
                        <div class="price-label">Total Amount</div>
                        <div class="price-amount">₹<span id="totalPrice">0.00</span></div>
                    </div>
                    
                    <button class="btn btn-primary" id="orderBtn" onclick="placeFinalOrder()">
                        <i class="fas fa-paper-plane"></i> Place Order Now
                    </button>
                </div>
            </div>

            <!-- Orders Page -->
            <div id="orders" class="page">
                <div class="page-header">
                    <div class="page-icon">
                        <i class="fas fa-list"></i>
                    </div>
                    <div>
                        <h1 class="page-title">My Orders</h1>
                        <p style="color: var(--text-light);">View your order history</p>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <h2 class="card-title">Recent Orders</h2>
                    </div>
                    
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Service</th>
                                <th>Quantity</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="ordersList">
                            <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Refill History Page -->
            <div id="refill" class="page">
                <div class="page-header">
                    <div class="page-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div>
                        <h1 class="page-title">Refill History</h1>
                        <p style="color: var(--text-light);">Track your refill requests</p>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <h2 class="card-title">Refill Requests</h2>
                    </div>
                    
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Service</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="refillList">
                            <!-- Refill history will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Services Page -->
            <div id="services" class="page">
                <div class="page-header">
                    <div class="page-icon">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div>
                        <h1 class="page-title">All Services</h1>
                        <p style="color: var(--text-light);">Browse available services</p>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-th-list"></i>
                        </div>
                        <h2 class="card-title">Service Categories</h2>
                    </div>
                    
                    <div id="allServices">
                        <!-- Services will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Deposit Page -->
            <div id="addfund" class="page">
                <div class="page-header">
                    <div class="page-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div>
                        <h1 class="page-title">Deposit Funds</h1>
                        <p style="color: var(--text-light);">Recharge your wallet instantly</p>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-qrcode"></i>
                        </div>
                        <h2 class="card-title">Payment Details</h2>
                    </div>
                    
                    <div style="background: rgba(99, 102, 241, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <i class="fas fa-university" style="color: var(--primary);"></i>
                            <span style="font-weight: 600;">UPI ID:</span>
                        </div>
                        <div style="font-size: 22px; font-weight: 700; color: var(--primary);">aqdaskhan03@fam</div>
                        <p style="color: var(--text-light); margin-top: 10px; font-size: 14px;">Send payment to this UPI ID and enter UTR below</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Amount (₹)</label>
                        <input type="number" id="amtInp" placeholder="Enter amount to add" class="input-field">
                    </div>
                    
                    <button class="btn btn-primary" onclick="genQR()">
                        <i class="fas fa-qrcode"></i> Generate Payment QR
                    </button>
                    
                    <div id="qrDiv" style="display: none; text-align: center; margin-top: 25px;">
                        <div style="background: white; padding: 15px; border-radius: 12px; display: inline-block; margin-bottom: 20px;">
                            <img id="qrImg" src="" style="width: 200px; height: 200px;">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">UTR / Transaction ID</label>
                            <input type="text" id="utrInp" placeholder="Enter UTR from your payment" class="input-field">
                        </div>
                        
                        <button class="btn btn-success-sm" style="width: 100%; padding: 15px; font-size: 16px;" onclick="submitUTR()">
                            <i class="fas fa-check-circle"></i> Confirm Payment
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tickets Page -->
            <div id="tickets" class="page">
                <div class="page-header">
                    <div class="page-icon">
                        <i class="fas fa-ticket-alt"></i>
                    </div>
                    <div>
                        <h1 class="page-title">Support Tickets</h1>
                        <p style="color: var(--text-light);">Manage your support tickets</p>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-plus-circle"></i>
                        </div>
                        <h2 class="card-title">Create New Ticket</h2>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Subject</label>
                        <input type="text" id="ticketSubject" placeholder="Enter ticket subject" class="input-field">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Message</label>
                        <textarea id="ticketMessage" placeholder="Describe your issue" class="input-field" rows="4"></textarea>
                    </div>
                    
                    <button class="btn btn-primary" onclick="createTicket()">
                        <i class="fas fa-paper-plane"></i> Submit Ticket
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-list"></i>
                        </div>
                        <h2 class="card-title">My Tickets</h2>
                    </div>
                    
                    <div id="ticketsList">
                        <!-- Tickets will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- API Page -->
            <div id="api" class="page">
                <div class="page-header">
                    <div class="page-icon">
                        <i class="fas fa-code"></i>
                    </div>
                    <div>
                        <h1 class="page-title">API Documentation</h1>
                        <p style="color: var(--text-light);">Integrate with our API</p>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-key"></i>
                        </div>
                        <h2 class="card-title">Your API Key</h2>
                    </div>
                    
                    <div class="api-key-box" id="apiKeyDisplay">
                        Loading API key...
                    </div>
                    
                    <button class="btn btn-primary" onclick="generateAPIKey()">
                        <i class="fas fa-key"></i> Generate New API Key
                    </button>
                </div>
            </div>

            <!-- Refer & Earn Page -->
            <div id="refer" class="page">
                <div class="page-header">
                    <div class="page-icon">
                        <i class="fas fa-gift"></i>
                    </div>
                    <div>
                        <h1 class="page-title">Refer & Earn</h1>
                        <p style="color: var(--text-light);">Invite friends and earn rewards</p>
                    </div>
                </div>
                
                <div class="referral-box">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">Your Referral Link</h3>
                    <div class="referral-code" id="referralCode">
                        Loading...
                    </div>
                    <button class="btn btn-primary" onclick="copyReferralLink()" style="width: auto; padding: 10px 25px;">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h2 class="card-title">Referral Statistics</h2>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div style="background: rgba(99, 102, 241, 0.1); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 28px; font-weight: 700; color: var(--primary);" id="refCount">0</div>
                            <div style="color: var(--text-light); font-size: 14px;">Total Referrals</div>
                        </div>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 28px; font-weight: 700; color: var(--accent);" id="refEarned">₹0.00</div>
                            <div style="color: var(--text-light); font-size: 14px;">Earned</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Support Page -->
            <div id="support" class="page">
                <div class="page-header">
                    <div class="page-icon">
                        <i class="fas fa-headset"></i>
                    </div>
                    <div>
                        <h1 class="page-title">24/7 Support</h1>
                        <p style="color: var(--text-light);">We're here to help you anytime</p>
                    </div>
                </div>
                
                <div class="support-grid">
                    <a href="https://wa.me/917775965170" target="_blank" class="support-card">
                        <div class="support-icon" style="background: linear-gradient(135deg, #25D366, #128C7E);">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <div class="support-info">
                            <h4>WhatsApp Support</h4>
                            <p>Instant chat support via WhatsApp</p>
                        </div>
                    </a>
                    
                    <a href="https://t.me/dgservice_support" target="_blank" class="support-card">
                        <div class="support-icon" style="background: linear-gradient(135deg, #0088cc, #006699);">
                            <i class="fab fa-telegram"></i>
                        </div>
                        <div class="support-info">
                            <h4>Telegram Channel</h4>
                            <p>Join our Telegram for updates & support</p>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile" class="page">
                <div class="page-header">
                    <div class="page-icon">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div>
                        <h1 class="page-title">My Profile</h1>
                        <p style="color: var(--text-light);">Manage your account details</p>
                    </div>
                </div>
                
                <div class="card profile-card">
                    <div class="profile-avatar">
                        <img id="uPfp" src="" alt="Profile Picture">
                    </div>
                    
                    <h2 class="profile-name" id="uName">User</h2>
                    <p class="profile-email" id="uEmail">user@example.com</p>
                    
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                        <div style="text-align: center; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 12px; min-width: 120px;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent);">₹<span id="profileBal">0.00</span></div>
                            <div style="font-size: 14px; color: var(--text-light);">Balance</div>
                        </div>
                        
                        <div style="text-align: center; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 12px; min-width: 120px;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--primary);" id="userStatus">Active</div>
                            <div style="font-size: 14px; color: var(--text-light);">Status</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ADMIN PANEL PAGE -->
            <div id="admin" class="page">
                <div class="page-header">
                    <div class="page-icon">
                        <i class="fas fa-lock"></i>
                    </div>
                    <div>
                        <h1 class="page-title">Admin Dashboard</h1>
                        <p style="color: var(--text-light);">Complete Control Panel</p>
                    </div>
                </div>

                <!-- Admin Tabs -->
                <div class="admin-tabs" id="adminTabs">
                    <div class="admin-tab active" onclick="openAdminTab('adminDashboard', this)">Dashboard</div>
                    <div class="admin-tab" onclick="openAdminTab('adminUsers', this)">Users</div>
                    <div class="admin-tab" onclick="openAdminTab('adminServices', this)">Services</div>
                    <div class="admin-tab" onclick="openAdminTab('adminOrders', this)">Orders</div>
                    <div class="admin-tab" onclick="openAdminTab('adminPayments', this)">Payments</div>
                    <div class="admin-tab" onclick="openAdminTab('adminTickets', this)">Tickets</div>
                    <div class="admin-tab" onclick="openAdminTab('adminScripts', this)">Scripts</div>
                    <div class="admin-tab" onclick="openAdminTab('adminAppearance', this)">Appearance</div>
                    <div class="admin-tab" onclick="openAdminTab('adminSettings', this)">Settings</div>
                    <div class="admin-tab" onclick="openAdminTab('adminExtra', this)">Extra Menu</div>
                </div>

                <!-- Admin Dashboard -->
                <div id="adminDashboard" class="admin-content active">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-tachometer-alt"></i>
                            </div>
                            <h2 class="card-title">Dashboard Overview</h2>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div style="background: rgba(99, 102, 241, 0.1); padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: var(--primary);" id="adminTotalUsers">0</div>
                                <div style="color: var(--text-light);">Total Users</div>
                            </div>
                            
                            <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: var(--accent);" id="adminTodayOrders">0</div>
                                <div style="color: var(--text-light);">Today's Orders</div>
                            </div>
                            
                            <div style="background: rgba(245, 158, 11, 0.1); padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: var(--warning);" id="adminPendingPayments">0</div>
                                <div style="color: var(--text-light);">Pending Payments</div>
                            </div>
                            
                            <div style="background: rgba(239, 68, 68, 0.1); padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: var(--danger);" id="adminOpenTickets">0</div>
                                <div style="color: var(--text-light);">Open Tickets</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <h2 class="card-title">Commission Settings</h2>
                        </div>
                        
                        <div class="commission-display">
                            <div class="commission-value" id="currentCommission">0%</div>
                            <div class="commission-label">Current Commission Rate</div>
                        </div>
                        
                        <div class="commission-input-container">
                            <div class="commission-input-box">
                                <input type="number" id="commInput" placeholder="Enter commission percentage (e.g., 15.5 for 15.5%)" class="commission-input" min="0" max="100" step="0.5">
                            </div>
                            <button class="btn btn-primary-sm" onclick="updateComm()" style="padding: 16px 30px; font-size: 16px;">
                                Update Commission
                            </button>
                        </div>
                    </div>
                </div>

                <!-- User Management -->
                <div id="adminUsers" class="admin-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <h2 class="card-title">User Management</h2>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="userSearch" placeholder="Search users by name, email, or ID" class="input-field" style="flex: 1;">
                            <button class="btn btn-primary-sm" onclick="searchUsers()">Search</button>
                        </div>
                        
                        <div id="adminUserList">
                            <!-- Users will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Service Management -->
                <div id="adminServices" class="admin-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <h2 class="card-title">Service Management</h2>
                        </div>
                        
                        <button class="btn btn-primary" onclick="showAddServiceModal()" style="margin-bottom: 20px;">
                            <i class="fas fa-plus"></i> Add New Service
                        </button>
                        
                        <div id="adminServiceList">
                            <!-- Services will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Orders Management -->
                <div id="adminOrders" class="admin-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <h2 class="card-title">Orders Management</h2>
                        </div>
                        
                        <div class="payment-filter-controls">
                            <select id="orderStatusFilter" onchange="filterOrders()">
                                <option value="all">All Orders</option>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                                <option value="failed">Failed</option>
                            </select>
                            
                            <input type="text" id="orderSearch" placeholder="Search by Order ID, Service, or User" onkeyup="filterOrders()" class="input-field">
                            
                            <select id="orderPerPage" onchange="changeOrderPerPage()">
                                <option value="10">10 per page</option>
                                <option value="25">25 per page</option>
                                <option value="50">50 per page</option>
                            </select>
                        </div>
                        
                        <div id="adminOrderList">
                            <!-- Orders will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Manual Payments Management -->
                <div id="adminPayments" class="admin-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-rupee-sign"></i>
                            </div>
                            <h2 class="card-title">Manual Payments Management</h2>
                        </div>
                        
                        <div class="payment-filter-controls">
                            <select id="statusFilter" onchange="filterPayments()">
                                <option value="all">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                            
                            <input type="text" id="paymentSearch" placeholder="Search by User ID, Username, UTR..." onkeyup="filterPayments()" class="input-field">
                            
                            <select id="itemsPerPage" onchange="changeItemsPerPage()">
                                <option value="10">10 per page</option>
                                <option value="25">25 per page</option>
                                <option value="50">50 per page</option>
                            </select>
                        </div>
                        
                        <div id="adminPaymentTable">
                            <!-- Payments will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Tickets Management -->
                <div id="adminTickets" class="admin-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-ticket-alt"></i>
                            </div>
                            <h2 class="card-title">Tickets Management</h2>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <button class="btn btn-primary-sm" onclick="showAllTickets()">All Tickets</button>
                            <button class="btn btn-warning-sm" onclick="showOpenTickets()">Open Tickets</button>
                            <button class="btn btn-success-sm" onclick="showClosedTickets()">Closed Tickets</button>
                        </div>
                        
                        <div id="adminTicketList">
                            <!-- Tickets will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Script Support -->
                <div id="adminScripts" class="admin-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-code"></i>
                            </div>
                            <h2 class="card-title">Script Support</h2>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin-bottom: 10px;">Custom JavaScript</h3>
                            <textarea id="customScript" class="script-code" placeholder="Enter custom JavaScript code here..."></textarea>
                            <button class="btn btn-primary" onclick="saveCustomScript()" style="margin-top: 10px;">
                                <i class="fas fa-save"></i> Save Script
                            </button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin-bottom: 10px;">Custom CSS</h3>
                            <textarea id="customCSS" class="script-code" placeholder="Enter custom CSS code here..."></textarea>
                            <button class="btn btn-primary" onclick="saveCustomCSS()" style="margin-top: 10px;">
                                <i class="fas fa-save"></i> Save CSS
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Appearance Settings -->
                <div id="adminAppearance" class="admin-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-paint-brush"></i>
                            </div>
                            <h2 class="card-title">Appearance Settings</h2>
                        </div>
                        
                        <div class="appearance-options">
                            <div class="appearance-option active" onclick="changeTheme('default')">
                                <i class="fas fa-palette" style="font-size: 24px; color: var(--primary); margin-bottom: 10px;"></i>
                                <div>Default Theme</div>
                            </div>
                            
                            <div class="appearance-option" onclick="changeTheme('dark')">
                                <i class="fas fa-moon" style="font-size: 24px; color: #6b7280; margin-bottom: 10px;"></i>
                                <div>Dark Theme</div>
                            </div>
                            
                            <div class="appearance-option" onclick="changeTheme('blue')">
                                <i class="fas fa-droplet" style="font-size: 24px; color: #3b82f6; margin-bottom: 10px;"></i>
                                <div>Blue Theme</div>
                            </div>
                            
                            <div class="appearance-option" onclick="changeTheme('green')">
                                <i class="fas fa-leaf" style="font-size: 24px; color: #10b981; margin-bottom: 10px;"></i>
                                <div>Green Theme</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <h3 style="margin-bottom: 10px;">Logo Settings</h3>
                            <input type="text" id="logoText" placeholder="Enter logo text" class="input-field" style="margin-bottom: 10px;">
                            <input type="color" id="primaryColor" value="#6366f1" style="margin-bottom: 10px;">
                            <button class="btn btn-primary" onclick="updateAppearance()">
                                <i class="fas fa-sync-alt"></i> Update Appearance
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div id="adminSettings" class="admin-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-cog"></i>
                            </div>
                            <h2 class="card-title">System Settings</h2>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin-bottom: 10px;">General Settings</h3>
                            <div class="form-group">
                                <label class="form-label">Site Title</label>
                                <input type="text" id="siteTitle" placeholder="Enter site title" class="input-field">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Site Description</label>
                                <textarea id="siteDescription" placeholder="Enter site description" class="input-field" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Minimum Deposit Amount</label>
                                <input type="number" id="minDeposit" placeholder="Enter minimum deposit" class="input-field">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Referral Commission (%)</label>
                                <input type="number" id="referralCommission" placeholder="Enter referral commission" class="input-field">
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>

                <!-- Extra Menu -->
                <div id="adminExtra" class="admin-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-plus-circle"></i>
                            </div>
                            <h2 class="card-title">Extra Menu Management</h2>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <button class="btn btn-primary" onclick="showAddMenuModal()">
                                <i class="fas fa-plus"></i> Add New Menu Item
                            </button>
                        </div>
                        
                        <div id="extraMenuList">
                            <!-- Extra menu items will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="openPage('home', this)">
                <div class="nav-icon">
                    <i class="fas fa-home"></i>
                </div>
                <div class="nav-label">Home</div>
            </div>
            
            <div class="nav-item" onclick="openPage('addfund', this)">
                <div class="nav-icon">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="nav-label">Deposit</div>
            </div>
            
            <div class="nav-item" onclick="openPage('orders', this)">
                <div class="nav-icon">
                    <i class="fas fa-list"></i>
                </div>
                <div class="nav-label">Orders</div>
            </div>
            
            <div class="nav-item" onclick="openPage('support', this)">
                <div class="nav-icon">
                    <i class="fas fa-headset"></i>
                </div>
                <div class="nav-label">Help</div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="addServiceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); padding: 30px; border-radius: 20px; width: 90%; max-width: 500px;">
            <h3 style="margin-bottom: 20px;">Add New Service</h3>
            <input type="text" id="newServiceName" placeholder="Service Name" class="input-field" style="margin-bottom: 15px;">
            <input type="text" id="newServiceCategory" placeholder="Category" class="input-field" style="margin-bottom: 15px;">
            <input type="number" id="newServicePrice" placeholder="Price per 1k" class="input-field" style="margin-bottom: 15px;">
            <input type="number" id="newServiceMin" placeholder="Minimum Quantity" class="input-field" style="margin-bottom: 15px;">
            <input type="number" id="newServiceMax" placeholder="Maximum Quantity" class="input-field" style="margin-bottom: 15px;">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="addNewService()">Add Service</button>
                <button class="btn btn-danger" onclick="closeModal('addServiceModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="addMenuModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); padding: 30px; border-radius: 20px; width: 90%; max-width: 500px;">
            <h3 style="margin-bottom: 20px;">Add New Menu Item</h3>
            <input type="text" id="newMenuName" placeholder="Menu Name" class="input-field" style="margin-bottom: 15px;">
            <input type="text" id="newMenuIcon" placeholder="Icon (e.g., fa-home)" class="input-field" style="margin-bottom: 15px;">
            <input type="text" id="newMenuUrl" placeholder="URL or Page ID" class="input-field" style="margin-bottom: 15px;">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="addNewMenuItem()">Add Menu</button>
                <button class="btn btn-danger" onclick="closeModal('addMenuModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // ============================
        // FIREBASE CONFIGURATION
        // ============================
        const firebaseConfig = {
            apiKey: "AIzaSyDkWf5kB35rbr6fQp5EJxwZ2bG6xzDlzZQ",
            authDomain: "otp-service-74871.firebaseapp.com",
            databaseURL: "https://otp-service-74871-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // ============================
        // GLOBAL VARIABLES
        // ============================
        const MY_UID = "ndjVRXUrm7byZUhfAMnIBhxUA0F3";
        const BACKEND_URL = "https://dg-otp-backend.onrender.com";
        let globalComm = 0;
        let allPayments = [];
        let allUsers = [];
        let allServices = [];
        let allOrders = [];
        let allTickets = [];
        let currentPage = 1;
        let itemsPerPage = 10;

        // ============================
        // SECURITY LAYER
        // ============================
        (function() {
            'use strict';
            
            console.log('🔒 DG Security Layer Initialized');
            
            // Domain validation
            const allowedDomains = ['dgotpservice.github.io'];
            const currentDomain = window.location.hostname.toLowerCase();
            let isValidDomain = false;
            
            for (let domain of allowedDomains) {
                if (currentDomain.includes(domain)) {
                    isValidDomain = true;
                    break;
                }
            }
            
            if (!isValidDomain && currentDomain !== '') {
                console.warn('⚠️ Running on unauthorized domain:', currentDomain);
            }
            
            // Multiple tabs protection
            if (sessionStorage.getItem('dg_tab_active')) {
                const tabCount = parseInt(sessionStorage.getItem('dg_tab_count') || '0');
                if (tabCount > 2) {
                    alert('🚫 Multiple tabs detected! Please use only one tab.');
                    if (confirm('Close this tab?')) {
                        window.close();
                        return;
                    }
                }
                sessionStorage.setItem('dg_tab_count', (tabCount + 1).toString());
            } else {
                sessionStorage.setItem('dg_tab_active', 'true');
                sessionStorage.setItem('dg_tab_count', '1');
            }
            
            // Cleanup on tab close
            window.addEventListener('beforeunload', function() {
                if (sessionStorage.getItem('dg_tab_active')) {
                    const tabs = parseInt(sessionStorage.getItem('dg_tab_count') || '1');
                    const newCount = Math.max(0, tabs - 1);
                    sessionStorage.setItem('dg_tab_count', newCount.toString());
                    if (newCount <= 0) {
                        sessionStorage.removeItem('dg_tab_active');
                    }
                }
            });
            
            // Prevent right click
            document.addEventListener('contextmenu', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }
                e.preventDefault();
            });
            
            console.log('✅ Security checks completed');
        })();

        // ============================
        // AUTHENTICATION FUNCTIONS
        // ============================
        auth.onAuthStateChanged(user => {
            if (user) {
                // Check if user is blocked
                db.ref('users/' + user.uid + '/status').on('value', snap => {
                    if (snap.val() === 'blocked') {
                        alert("Your account has been blocked!");
                        auth.signOut();
                        return;
                    }
                    if (document.getElementById('userStatus')) {
                        document.getElementById('userStatus').innerText = snap.val() || 'Active';
                    }
                });
                
                // Show app, hide auth
                document.getElementById('authBox').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                // Update user profile
                const displayName = user.displayName || 'User';
                const email = user.email || 'user@email.com';
                const photoURL = user.photoURL || "https://ui-avatars.com/api/?name=" + encodeURIComponent(displayName) + "&background=6366f1&color=fff";
                
                // Update profile elements
                const uNameEl = document.getElementById('uName');
                const uEmailEl = document.getElementById('uEmail');
                const uPfpEl = document.getElementById('uPfp');
                const sidebarNameEl = document.getElementById('sidebarName');
                const sidebarEmailEl = document.getElementById('sidebarEmail');
                const sidebarPfpEl = document.getElementById('sidebarPfp');
                
                if (uNameEl) uNameEl.innerText = displayName;
                if (uEmailEl) uEmailEl.innerText = email;
                if (uPfpEl) uPfpEl.src = photoURL;
                if (sidebarNameEl) sidebarNameEl.innerText = displayName;
                if (sidebarEmailEl) sidebarEmailEl.innerText = email;
                if (sidebarPfpEl) sidebarPfpEl.src = photoURL;
                
                // Load commission
                db.ref('settings/commission').on('value', snap => {
                    globalComm = snap.val() || 0;
                    if (user.uid === MY_UID) {
                        const commInput = document.getElementById('commInput');
                        const currentCommission = document.getElementById('currentCommission');
                        if (commInput) commInput.value = globalComm;
                        if (currentCommission) currentCommission.innerText = globalComm + "%";
                    }
                });
                
                // Check admin status
                checkAdminStatus(user);
                
                // Load balance
                db.ref('users/' + user.uid + '/balance').on('value', snap => {
                    const balance = (snap.val() || 0).toFixed(2);
                    const balText = document.getElementById('balText');
                    const profileBal = document.getElementById('profileBal');
                    if (balText) balText.innerText = balance;
                    if (profileBal) profileBal.innerText = balance;
                });
                
                // Load user data for other pages
                loadOrders();
                loadRefillHistory();
                loadAllServices();
                loadTickets();
                loadAPIKey();
                loadReferralData();
                
            } else {
                // Show auth, hide app
                document.getElementById('authBox').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        function checkAdminStatus(user) {
            const userRef = db.ref('users/' + user.uid);
            userRef.once('value').then(snapshot => {
                const userData = snapshot.val();
                if (userData && (userData.admin === true || user.uid === MY_UID)) {
                    document.getElementById('adminBtn').style.display = 'flex';
                    document.getElementById('adminSubmenu').style.display = 'block';
                    loadAdminData();
                } else {
                    document.getElementById('adminBtn').style.display = 'none';
                    document.getElementById('adminSubmenu').style.display = 'none';
                }
            });
        }

        // ============================
        // ADMIN FUNCTIONS
        // ============================
        function loadAdminData() {
            loadAdminDashboard();
            loadAllUsers();
            loadAllServicesForAdmin();
            loadAllOrders();
            loadAllPaymentRequests();
            loadAllTickets();
            loadAdminSettings();
            loadExtraMenu();
        }

        function loadAdminDashboard() {
            // Load total users
            db.ref('users').once('value').then(snap => {
                document.getElementById('adminTotalUsers').innerText = snap.numChildren();
            });

            // Load today's orders
            const today = new Date();
            const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
            db.ref('orders').once('value').then(snap => {
                let count = 0;
                snap.forEach(userOrders => {
                    userOrders.forEach(order => {
                        if (order.val().timestamp >= startOfDay) {
                            count++;
                        }
                    });
                });
                document.getElementById('adminTodayOrders').innerText = count;
            });

            // Load pending payments
            db.ref('paymentRequests').orderByChild('status').equalTo('pending').once('value').then(snap => {
                document.getElementById('adminPendingPayments').innerText = snap.numChildren();
            });

            // Load open tickets
            db.ref('tickets').once('value').then(snap => {
                let count = 0;
                snap.forEach(userTickets => {
                    userTickets.forEach(ticket => {
                        if (ticket.val().status === 'open') {
                            count++;
                        }
                    });
                });
                document.getElementById('adminOpenTickets').innerText = count;
            });
        }

        function loadAllUsers() {
            const userListDiv = document.getElementById('adminUserList');
            userListDiv.innerHTML = '<p style="color: var(--text-light); text-align: center;">Loading users...</p>';
            
            const usersRef = db.ref('users');
            usersRef.once('value').then(snapshot => {
                allUsers = [];
                const users = snapshot.val();
                userListDiv.innerHTML = '';
                
                if (!users) {
                    userListDiv.innerHTML = '<p style="color: var(--text-light); text-align: center;">No users found</p>';
                    return;
                }
                
                Object.keys(users).forEach(uid => {
                    allUsers.push({
                        id: uid,
                        ...users[uid]
                    });
                    
                    const user = users[uid];
                    const userCard = document.createElement('div');
                    userCard.className = 'admin-user-card';
                    
                    userCard.innerHTML = `
                        <div class="user-info">
                            <h5>${user.name || 'No Name'}</h5>
                            <div class="user-details">
                                <span>Email: ${user.email || 'No Email'}</span>
                                <span>Balance: ₹${user.balance || '0.00'}</span>
                                <span>Status: ${user.status || 'Active'}</span>
                                <span>Joined: ${new Date(user.createdAt).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="admin-actions">
                            ${user.admin ? 
                                '<span style="color: var(--warning); font-weight: 600;">Admin</span>' : 
                                `<button class="btn-sm btn-primary-sm" onclick="makeAdmin('${uid}')">Make Admin</button>`
                            }
                            <button class="btn-sm btn-warning-sm" onclick="editUser('${uid}')">Edit</button>
                            ${user.status === 'banned' ? 
                                `<button class="btn-sm btn-success-sm" onclick="unbanUser('${uid}')">Unban</button>` :
                                `<button class="btn-sm btn-danger-sm" onclick="banUser('${uid}')">Ban</button>`
                            }
                            <button class="btn-sm btn-info-sm" onclick="resetPassword('${uid}')">Reset Pass</button>
                        </div>
                    `;
                    
                    userListDiv.appendChild(userCard);
                });
            });
        }

        function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                (user.id && user.id.toLowerCase().includes(searchTerm))
            );
            
            const userListDiv = document.getElementById('adminUserList');
            userListDiv.innerHTML = '';
            
            if (filteredUsers.length === 0) {
                userListDiv.innerHTML = '<p style="color: var(--text-light); text-align: center;">No users found</p>';
                return;
            }
            
            filteredUsers.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'admin-user-card';
                
                userCard.innerHTML = `
                    <div class="user-info">
                        <h5>${user.name || 'No Name'}</h5>
                        <div class="user-details">
                            <span>Email: ${user.email || 'No Email'}</span>
                            <span>Balance: ₹${user.balance || '0.00'}</span>
                            <span>Status: ${user.status || 'Active'}</span>
                            <span>Joined: ${new Date(user.createdAt).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="admin-actions">
                        ${user.admin ? 
                            '<span style="color: var(--warning); font-weight: 600;">Admin</span>' : 
                            `<button class="btn-sm btn-primary-sm" onclick="makeAdmin('${user.id}')">Make Admin</button>`
                        }
                        <button class="btn-sm btn-warning-sm" onclick="editUser('${user.id}')">Edit</button>
                        ${user.status === 'banned' ? 
                            `<button class="btn-sm btn-success-sm" onclick="unbanUser('${user.id}')">Unban</button>` :
                            `<button class="btn-sm btn-danger-sm" onclick="banUser('${user.id}')">Ban</button>`
                        }
                        <button class="btn-sm btn-info-sm" onclick="resetPassword('${user.id}')">Reset Pass</button>
                    </div>
                `;
                
                userListDiv.appendChild(userCard);
            });
        }

        function makeAdmin(uid) {
            if (!confirm('Are you sure you want to make this user an admin?')) return;
            
            const userRef = db.ref('users/' + uid + '/admin');
            userRef.set(true)
                .then(() => {
                    alert('User promoted to admin successfully!');
                    loadAllUsers();
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
        }

        function banUser(uid) {
            if (!confirm('Are you sure you want to ban this user?')) return;
            
            const userRef = db.ref('users/' + uid);
            userRef.update({ status: 'banned' })
                .then(() => {
                    alert('User banned successfully!');
                    loadAllUsers();
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
        }

        function unbanUser(uid) {
            if (!confirm('Are you sure you want to unban this user?')) return;
            
            const userRef = db.ref('users/' + uid);
            userRef.update({ status: 'active' })
                .then(() => {
                    alert('User unbanned successfully!');
                    loadAllUsers();
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
        }

        function editUser(uid) {
            const userRef = db.ref('users/' + uid);
            userRef.once('value').then(snapshot => {
                const user = snapshot.val();
                
                const newName = prompt('Enter new name:', user.name || '');
                if (newName === null) return;
                
                const newBalance = prompt('Enter new balance:', user.balance || '0');
                if (newBalance === null) return;
                
                const newStatus = prompt('Enter new status (active/banned):', user.status || 'active');
                if (newStatus === null) return;
                
                userRef.update({
                    name: newName,
                    balance: parseFloat(newBalance),
                    status: newStatus,
                    lastUpdated: Date.now(),
                    updatedBy: auth.currentUser.uid
                })
                .then(() => {
                    alert('User updated successfully!');
                    loadAllUsers();
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
            });
        }

        function resetPassword(uid) {
            if (!confirm('Reset password for this user? They will receive an email to reset password.')) return;
            
            const userRef = db.ref('users/' + uid + '/email');
            userRef.once('value').then(snapshot => {
                const email = snapshot.val();
                if (email) {
                    auth.sendPasswordResetEmail(email)
                        .then(() => {
                            alert('Password reset email sent successfully!');
                        })
                        .catch(error => {
                            alert('Error: ' + error.message);
                        });
                } else {
                    alert('User email not found!');
                }
            });
        }

        function loadAllServicesForAdmin() {
            const serviceListDiv = document.getElementById('adminServiceList');
            serviceListDiv.innerHTML = '<p style="color: var(--text-light); text-align: center;">Loading services...</p>';
            
            fetch(`${BACKEND_URL}/get-services`)
                .then(res => res.json())
                .then(services => {
                    allServices = services;
                    serviceListDiv.innerHTML = '';
                    
                    if (!services || services.length === 0) {
                        serviceListDiv.innerHTML = '<p style="color: var(--text-light); text-align: center;">No services found</p>';
                        return;
                    }
                    
                    services.forEach(service => {
                        const serviceItem = document.createElement('div');
                        serviceItem.className = 'service-item';
                        
                        serviceItem.innerHTML = `
                            <div class="service-details">
                                <h4>${service.name}</h4>
                                <div style="color: var(--text-light); font-size: 14px;">
                                    Category: ${service.category} | Price: ₹${service.price}/1k
                                    <br>Min: ${service.min} | Max: ${service.max}
                                </div>
                            </div>
                            <div class="service-actions">
                                <button class="btn-sm btn-warning-sm" onclick="editService('${service.id}')">Edit</button>
                                <button class="btn-sm btn-danger-sm" onclick="deleteService('${service.id}')">Delete</button>
                            </div>
                        `;
                        
                        serviceListDiv.appendChild(serviceItem);
                    });
                })
                .catch(error => {
                    console.error('Error loading services:', error);
                    serviceListDiv.innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading services</p>';
                });
        }

        function showAddServiceModal() {
            document.getElementById('addServiceModal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function addNewService() {
            const name = document.getElementById('newServiceName').value;
            const category = document.getElementById('newServiceCategory').value;
            const price = document.getElementById('newServicePrice').value;
            const min = document.getElementById('newServiceMin').value;
            const max = document.getElementById('newServiceMax').value;
            
            if (!name || !category || !price || !min || !max) {
                alert('Please fill all fields!');
                return;
            }
            
            // Note: In a real implementation, you would send this to your backend
            // For now, we'll just show a message
            alert('Service added successfully! (Note: This would connect to your backend API)');
            closeModal('addServiceModal');
            loadAllServicesForAdmin();
        }

        function editService(serviceId) {
            alert('Edit service functionality would connect to your backend API. Service ID: ' + serviceId);
        }

        function deleteService(serviceId) {
            if (!confirm('Are you sure you want to delete this service?')) return;
            alert('Service deleted! (Note: This would connect to your backend API)');
            loadAllServicesForAdmin();
        }

        function loadAllOrders() {
            const orderListDiv = document.getElementById('adminOrderList');
            orderListDiv.innerHTML = '<p style="color: var(--text-light); text-align: center;">Loading orders...</p>';
            
            db.ref('orders').once('value').then(snapshot => {
                allOrders = [];
                const orders = snapshot.val();
                orderListDiv.innerHTML = '';
                
                if (!orders) {
                    orderListDiv.innerHTML = '<p style="color: var(--text-light); text-align: center;">No orders found</p>';
                    return;
                }
                
                Object.keys(orders).forEach(userId => {
                    Object.keys(orders[userId]).forEach(orderId => {
                        const order = orders[userId][orderId];
                        allOrders.push({
                            id: orderId,
                            userId: userId,
                            ...order
                        });
                    });
                });
                
                renderOrderTable();
            });
        }

        function renderOrderTable() {
            const orderListDiv = document.getElementById('adminOrderList');
            const filteredOrders = filterOrderData();
            const totalPages = Math.ceil(filteredOrders.length / itemsPerPage);
            
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentOrders = filteredOrders.slice(startIndex, endIndex);
            
            orderListDiv.innerHTML = `
                <div class="payment-table-container">
                    <table class="payment-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>User</th>
                                <th>Service</th>
                                <th>Quantity</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentOrders.map((order, index) => `
                                <tr>
                                    <td>${order.id.substring(0, 8)}</td>
                                    <td>${getUserName(order.userId)}</td>
                                    <td>${order.service || 'N/A'}</td>
                                    <td>${order.quantity || 0}</td>
                                    <td>₹${order.amount || '0.00'}</td>
                                    <td>
                                        <span class="status-badge status-${order.status}">
                                            ${order.status || 'pending'}
                                        </span>
                                    </td>
                                    <td>${new Date(order.timestamp).toLocaleDateString()}</td>
                                    <td>
                                        <div class="payment-actions">
                                            <button class="btn-action btn-info" onclick="viewOrderDetails('${order.id}')">
                                                View
                                            </button>
                                            <button class="btn-action btn-warning" onclick="updateOrderStatus('${order.id}')">
                                                Update
                                            </button>
                                            ${order.status === 'pending' ? `
                                                <button class="btn-action btn-success" onclick="completeOrder('${order.id}')">
                                                    Complete
                                                </button>
                                                <button class="btn-action btn-danger" onclick="cancelOrder('${order.id}')">
                                                    Cancel
                                                </button>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination-controls">
                    <div class="pagination-info">
                        Showing ${startIndex + 1} to ${Math.min(endIndex, filteredOrders.length)} of ${filteredOrders.length} entries
                    </div>
                    <div class="pagination-buttons">
                        <button onclick="changeOrderPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                            Previous
                        </button>
                        ${Array.from({length: totalPages}, (_, i) => i + 1).map(page => `
                            <button onclick="changeOrderPage(${page})" class="${page === currentPage ? 'active' : ''}">
                                ${page}
                            </button>
                        `).join('')}
                        <button onclick="changeOrderPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                            Next
                        </button>
                    </div>
                </div>
            `;
        }

        function getUserName(userId) {
            const user = allUsers.find(u => u.id === userId);
            return user ? user.name : 'Unknown';
        }

        function filterOrderData() {
            const statusFilter = document.getElementById('orderStatusFilter')?.value || 'all';
            const searchTerm = document.getElementById('orderSearch')?.value?.toLowerCase() || '';
            
            return allOrders.filter(order => {
                // Status filter
                if (statusFilter !== 'all' && order.status !== statusFilter) {
                    return false;
                }
                
                // Search filter
                if (searchTerm) {
                    const searchIn = [
                        order.id || '',
                        order.service || '',
                        getUserName(order.userId) || '',
                        order.amount?.toString() || ''
                    ].join(' ').toLowerCase();
                    
                    return searchIn.includes(searchTerm);
                }
                
                return true;
            });
        }

        function filterOrders() {
            currentPage = 1;
            renderOrderTable();
        }

        function changeOrderPerPage() {
            itemsPerPage = parseInt(document.getElementById('orderPerPage').value);
            currentPage = 1;
            renderOrderTable();
        }

        function changeOrderPage(page) {
            const filteredOrders = filterOrderData();
            const totalPages = Math.ceil(filteredOrders.length / itemsPerPage);
            
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderOrderTable();
            }
        }

        function viewOrderDetails(orderId) {
            alert('View order details for: ' + orderId);
        }

        function updateOrderStatus(orderId) {
            const newStatus = prompt('Enter new status (pending/completed/failed):', 'completed');
            if (newStatus) {
                // Find order and update in database
                alert('Order status updated to: ' + newStatus);
                loadAllOrders();
            }
        }

        function completeOrder(orderId) {
            if (confirm('Mark this order as completed?')) {
                alert('Order marked as completed!');
                loadAllOrders();
            }
        }

        function cancelOrder(orderId) {
            if (confirm('Cancel this order?')) {
                alert('Order cancelled!');
                loadAllOrders();
            }
        }

        function loadAllPaymentRequests() {
            const paymentsRef = db.ref('paymentRequests');
            paymentsRef.once('value').then(snapshot => {
                allPayments = [];
                const payments = snapshot.val();
                
                if (!payments) {
                    renderPaymentTable();
                    return;
                }
                
                Object.keys(payments).forEach(paymentId => {
                    allPayments.push({
                        id: paymentId,
                        ...payments[paymentId]
                    });
                });
                
                // Sort by timestamp (newest first)
                allPayments.sort((a, b) => b.timestamp - a.timestamp);
                
                renderPaymentTable();
            });
        }

        function renderPaymentTable() {
            const paymentsDiv = document.getElementById('adminPaymentTable');
            const filteredPayments = filterPaymentData();
            const totalPages = Math.ceil(filteredPayments.length / itemsPerPage);
            
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentPayments = filteredPayments.slice(startIndex, endIndex);
            
            paymentsDiv.innerHTML = `
                <div class="payment-table-container">
                    <table class="payment-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>User ID</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>UTR</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentPayments.map((payment, index) => `
                                <tr>
                                    <td>${startIndex + index + 1}</td>
                                    <td>${payment.name || payment.userName || 'Unknown'}</td>
                                    <td>${payment.uid || payment.userId ? (payment.uid || payment.userId).substring(0, 8) : 'N/A'}</td>
                                    <td>₹${parseFloat(payment.amount || payment.amt || 0).toFixed(2)}</td>
                                    <td>${payment.method || 'UPI 1'}</td>
                                    <td>${payment.utr || 'N/A'}</td>
                                    <td>
                                        <span class="status-badge status-${payment.status}">
                                            ${payment.status.charAt(0).toUpperCase() + payment.status.slice(1)}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="payment-actions">
                                            ${payment.status === 'pending' ? `
                                                <button class="btn-action btn-success" onclick="approvePayment('${payment.id}', '${payment.uid || payment.userId}', ${payment.amount || payment.amt})">
                                                    Approve
                                                </button>
                                                <button class="btn-action btn-danger" onclick="rejectPayment('${payment.id}')">
                                                    Reject
                                                </button>
                                            ` : ''}
                                            <button class="btn-action btn-info" onclick="viewPaymentDetails('${payment.id}')">
                                                View
                                            </button>
                                            <button class="btn-action btn-warning" onclick="editPayment('${payment.id}')">
                                                Edit
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination-controls">
                    <div class="pagination-info">
                        Showing ${startIndex + 1} to ${Math.min(endIndex, filteredPayments.length)} of ${filteredPayments.length} entries
                    </div>
                    <div class="pagination-buttons">
                        <button onclick="changePaymentPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                            Previous
                        </button>
                        ${Array.from({length: totalPages}, (_, i) => i + 1).map(page => `
                            <button onclick="changePaymentPage(${page})" class="${page === currentPage ? 'active' : ''}">
                                ${page}
                            </button>
                        `).join('')}
                        <button onclick="changePaymentPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                            Next
                        </button>
                    </div>
                </div>
            `;
        }

        function filterPaymentData() {
            const statusFilter = document.getElementById('statusFilter')?.value || 'all';
            const searchTerm = document.getElementById('paymentSearch')?.value?.toLowerCase() || '';
            
            return allPayments.filter(payment => {
                // Status filter
                if (statusFilter !== 'all' && payment.status !== statusFilter) {
                    return false;
                }
                
                // Search filter
                if (searchTerm) {
                    const searchIn = [
                        payment.name || payment.userName || '',
                        payment.uid || payment.userId || '',
                        payment.utr || '',
                        (payment.amount || payment.amt || 0).toString(),
                        payment.method || ''
                    ].join(' ').toLowerCase();
                    
                    return searchIn.includes(searchTerm);
                }
                
                return true;
            });
        }

        function filterPayments() {
            currentPage = 1;
            renderPaymentTable();
        }

        function changeItemsPerPage() {
            itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            currentPage = 1;
            renderPaymentTable();
        }

        function changePaymentPage(page) {
            const filteredPayments = filterPaymentData();
            const totalPages = Math.ceil(filteredPayments.length / itemsPerPage);
            
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderPaymentTable();
            }
        }

        function approvePayment(paymentId, userId, amount) {
            if (!confirm('Approve this payment request?')) return;
            
            const paymentRef = db.ref('paymentRequests/' + paymentId);
            const userRef = db.ref('users/' + userId + '/balance');
            
            // Get current balance
            userRef.once('value').then(snapshot => {
                const currentBalance = parseFloat(snapshot.val()) || 0;
                const newBalance = currentBalance + parseFloat(amount);
                
                // Update payment status
                paymentRef.update({ 
                    status: 'approved', 
                    approvedAt: Date.now(),
                    approvedBy: auth.currentUser.uid 
                })
                .then(() => {
                    // Update user balance
                    return userRef.set(newBalance);
                })
                .then(() => {
                    alert('Payment approved and balance updated!');
                    loadAllPaymentRequests();
                    loadAdminDashboard();
                    
                    // If current user is the one who got payment, update display
                    const currentUser = auth.currentUser;
                    if (currentUser && currentUser.uid === userId) {
                        document.getElementById('balText').textContent = newBalance.toFixed(2);
                        document.getElementById('profileBal').textContent = newBalance.toFixed(2);
                    }
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
            });
        }

        function rejectPayment(paymentId) {
            if (!confirm('Reject this payment request?')) return;
            
            const paymentRef = db.ref('paymentRequests/' + paymentId);
            paymentRef.update({ 
                status: 'rejected', 
                rejectedAt: Date.now(),
                rejectedBy: auth.currentUser.uid 
            })
            .then(() => {
                alert('Payment rejected!');
                loadAllPaymentRequests();
                loadAdminDashboard();
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }

        function viewPaymentDetails(paymentId) {
            const paymentRef = db.ref('paymentRequests/' + paymentId);
            paymentRef.once('value').then(snapshot => {
                const payment = snapshot.val();
                
                if (!payment) {
                    alert('Payment not found!');
                    return;
                }
                
                const details = `
                    Payment ID: ${paymentId}
                    User: ${payment.name || payment.userName} (${(payment.uid || payment.userId || '').substring(0, 8)})
                    Amount: ₹${payment.amount || payment.amt}
                    Method: ${payment.method || 'Not specified'}
                    UTR: ${payment.utr}
                    Status: ${payment.status}
                    Date: ${new Date(payment.timestamp).toLocaleString()}
                    ${payment.approvedAt ? `Approved: ${new Date(payment.approvedAt).toLocaleString()}` : ''}
                    ${payment.rejectedAt ? `Rejected: ${new Date(payment.rejectedAt).toLocaleString()}` : ''}
                `;
                
                alert(details);
            });
        }

        function editPayment(paymentId) {
            const paymentRef = db.ref('paymentRequests/' + paymentId);
            paymentRef.once('value').then(snapshot => {
                const payment = snapshot.val();
                
                const newAmount = prompt('Enter new amount:', payment.amount || payment.amt);
                if (newAmount === null) return;
                
                const newUTR = prompt('Enter new UTR:', payment.utr);
                if (newUTR === null) return;
                
                const newMethod = prompt('Enter new method:', payment.method || 'UPI 1');
                if (newMethod === null) return;
                
                paymentRef.update({
                    amount: parseFloat(newAmount),
                    utr: newUTR,
                    method: newMethod,
                    lastUpdated: Date.now(),
                    updatedBy: auth.currentUser.uid
                })
                .then(() => {
                    alert('Payment updated successfully!');
                    loadAllPaymentRequests();
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
            });
        }

        function loadAllTickets() {
            const ticketListDiv = document.getElementById('adminTicketList');
            ticketListDiv.innerHTML = '<p style="color: var(--text-light); text-align: center;">Loading tickets...</p>';
            
            db.ref('tickets').once('value').then(snapshot => {
                allTickets = [];
                const tickets = snapshot.val();
                ticketListDiv.innerHTML = '';
                
                if (!tickets) {
                    ticketListDiv.innerHTML = '<p style="color: var(--text-light); text-align: center;">No tickets found</p>';
                    return;
                }
                
                Object.keys(tickets).forEach(userId => {
                    Object.keys(tickets[userId]).forEach(ticketId => {
                        const ticket = tickets[userId][ticketId];
                        allTickets.push({
                            id: ticketId,
                            userId: userId,
                            ...ticket
                        });
                    });
                });
                
                showAllTickets();
            });
        }

        function showAllTickets() {
            renderTicketTable(allTickets);
        }

        function showOpenTickets() {
            const openTickets = allTickets.filter(ticket => ticket.status === 'open');
            renderTicketTable(openTickets);
        }

        function showClosedTickets() {
            const closedTickets = allTickets.filter(ticket => ticket.status === 'closed');
            renderTicketTable(closedTickets);
        }

        function renderTicketTable(tickets) {
            const ticketListDiv = document.getElementById('adminTicketList');
            
            if (tickets.length === 0) {
                ticketListDiv.innerHTML = '<p style="color: var(--text-light); text-align: center;">No tickets found</p>';
                return;
            }
            
            let html = '';
            tickets.forEach(ticket => {
                html += `
                    <div class="ticket-message">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <div>
                                <strong>${ticket.subject}</strong>
                                <div style="font-size: 12px; color: var(--text-light);">
                                    From: ${ticket.name || ticket.email} | ${new Date(ticket.timestamp).toLocaleString()}
                                </div>
                            </div>
                            <span class="status-badge status-${ticket.status}" style="font-size: 12px;">
                                ${ticket.status}
                            </span>
                        </div>
                        <div style="color: var(--text-light); margin-bottom: 10px;">${ticket.message}</div>
                        <div class="admin-actions">
                            <button class="btn-sm btn-primary-sm" onclick="replyToTicket('${ticket.id}', '${ticket.userId}')">Reply</button>
                            ${ticket.status === 'open' ? 
                                `<button class="btn-sm btn-success-sm" onclick="closeTicket('${ticket.id}', '${ticket.userId}')">Close</button>` :
                                `<button class="btn-sm btn-warning-sm" onclick="reopenTicket('${ticket.id}', '${ticket.userId}')">Reopen</button>`
                            }
                            <button class="btn-sm btn-danger-sm" onclick="deleteTicket('${ticket.id}', '${ticket.userId}')">Delete</button>
                        </div>
                    </div>
                `;
            });
            
            ticketListDiv.innerHTML = html;
        }

        function replyToTicket(ticketId, userId) {
            const reply = prompt('Enter your reply to this ticket:');
            if (reply) {
                // In a real implementation, you would save this reply to the database
                alert('Reply sent successfully!');
            }
        }

        function closeTicket(ticketId, userId) {
            if (confirm('Close this ticket?')) {
                db.ref('tickets/' + userId + '/' + ticketId + '/status').set('closed')
                    .then(() => {
                        alert('Ticket closed successfully!');
                        loadAllTickets();
                        loadAdminDashboard();
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    });
            }
        }

        function reopenTicket(ticketId, userId) {
            if (confirm('Reopen this ticket?')) {
                db.ref('tickets/' + userId + '/' + ticketId + '/status').set('open')
                    .then(() => {
                        alert('Ticket reopened successfully!');
                        loadAllTickets();
                        loadAdminDashboard();
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    });
            }
        }

        function deleteTicket(ticketId, userId) {
            if (confirm('Delete this ticket?')) {
                db.ref('tickets/' + userId + '/' + ticketId).remove()
                    .then(() => {
                        alert('Ticket deleted successfully!');
                        loadAllTickets();
                        loadAdminDashboard();
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    });
            }
        }

        function saveCustomScript() {
            const script = document.getElementById('customScript').value;
            localStorage.setItem('dg_custom_script', script);
            alert('Custom script saved!');
        }

        function saveCustomCSS() {
            const css = document.getElementById('customCSS').value;
            localStorage.setItem('dg_custom_css', css);
            alert('Custom CSS saved!');
        }

        function changeTheme(theme) {
            document.querySelectorAll('.appearance-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.closest('.appearance-option').classList.add('active');
            
            localStorage.setItem('dg_theme', theme);
            alert('Theme changed to ' + theme + '!');
        }

        function updateAppearance() {
            const logoText = document.getElementById('logoText').value;
            const primaryColor = document.getElementById('primaryColor').value;
            
            if (logoText) {
                document.querySelectorAll('.logo span, .sidebar-title').forEach(el => {
                    el.textContent = logoText;
                });
            }
            
            if (primaryColor) {
                document.documentElement.style.setProperty('--primary', primaryColor);
                document.documentElement.style.setProperty('--primary-dark', darkenColor(primaryColor, 20));
            }
            
            localStorage.setItem('dg_logo_text', logoText);
            localStorage.setItem('dg_primary_color', primaryColor);
            alert('Appearance updated successfully!');
        }

        function darkenColor(color, percent) {
            // Simple color darkening function
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) - amt;
            const G = (num >> 8 & 0x00FF) - amt;
            const B = (num & 0x0000FF) - amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }

        function loadAdminSettings() {
            db.ref('settings').once('value').then(snapshot => {
                const settings = snapshot.val() || {};
                document.getElementById('siteTitle').value = settings.siteTitle || 'DG Social Service';
                document.getElementById('siteDescription').value = settings.siteDescription || '';
                document.getElementById('minDeposit').value = settings.minDeposit || 10;
                document.getElementById('referralCommission').value = settings.referralCommission || 10;
            });
        }

        function saveSettings() {
            const settings = {
                siteTitle: document.getElementById('siteTitle').value,
                siteDescription: document.getElementById('siteDescription').value,
                minDeposit: parseFloat(document.getElementById('minDeposit').value) || 10,
                referralCommission: parseFloat(document.getElementById('referralCommission').value) || 10,
                updatedAt: Date.now(),
                updatedBy: auth.currentUser.uid
            };
            
            db.ref('settings').update(settings)
                .then(() => {
                    alert('Settings saved successfully!');
                })
                .catch(error => {
                    alert('Error saving settings: ' + error.message);
                });
        }

        function loadExtraMenu() {
            const menuListDiv = document.getElementById('extraMenuList');
            db.ref('extraMenu').once('value').then(snapshot => {
                const menuItems = snapshot.val();
                menuListDiv.innerHTML = '';
                
                if (!menuItems) {
                    menuListDiv.innerHTML = '<p style="color: var(--text-light); text-align: center;">No extra menu items found</p>';
                    return;
                }
                
                Object.keys(menuItems).forEach(itemId => {
                    const item = menuItems[itemId];
                    const menuItem = document.createElement('div');
                    menuItem.className = 'admin-user-card';
                    
                    menuItem.innerHTML = `
                        <div class="user-info">
                            <h5>${item.name}</h5>
                            <div class="user-details">
                                <span>Icon: ${item.icon}</span>
                                <span>URL: ${item.url}</span>
                            </div>
                        </div>
                        <div class="admin-actions">
                            <button class="btn-sm btn-warning-sm" onclick="editMenuItem('${itemId}')">Edit</button>
                            <button class="btn-sm btn-danger-sm" onclick="deleteMenuItem('${itemId}')">Delete</button>
                        </div>
                    `;
                    
                    menuListDiv.appendChild(menuItem);
                });
            });
        }

        function showAddMenuModal() {
            document.getElementById('addMenuModal').style.display = 'flex';
        }

        function addNewMenuItem() {
            const name = document.getElementById('newMenuName').value;
            const icon = document.getElementById('newMenuIcon').value;
            const url = document.getElementById('newMenuUrl').value;
            
            if (!name || !icon || !url) {
                alert('Please fill all fields!');
                return;
            }
            
            const newItem = {
                name: name,
                icon: icon,
                url: url,
                createdAt: Date.now(),
                createdBy: auth.currentUser.uid
            };
            
            const newItemRef = db.ref('extraMenu').push();
            newItemRef.set(newItem)
                .then(() => {
                    alert('Menu item added successfully!');
                    closeModal('addMenuModal');
                    loadExtraMenu();
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
        }

        function editMenuItem(itemId) {
            const name = prompt('Enter new menu name:');
            if (name) {
                db.ref('extraMenu/' + itemId + '/name').set(name)
                    .then(() => {
                        alert('Menu item updated!');
                        loadExtraMenu();
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    });
            }
        }

        function deleteMenuItem(itemId) {
            if (confirm('Delete this menu item?')) {
                db.ref('extraMenu/' + itemId).remove()
                    .then(() => {
                        alert('Menu item deleted!');
                        loadExtraMenu();
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    });
            }
        }

        function openAdminTab(tabId, element) {
            // Update tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (element) element.classList.add('active');
            
            // Update content
            document.querySelectorAll('.admin-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        }

        // ============================
        // MAIN APPLICATION FUNCTIONS
        // ============================
        function updateComm() {
            const commInput = document.getElementById('commInput');
            if (!commInput) return;
            
            const val = parseFloat(commInput.value);
            if (isNaN(val) || val < 0 || val > 100) {
                alert("Please enter a valid commission percentage (0-100)");
                return;
            }
            
            db.ref('settings/commission').set(val).then(() => {
                alert("Commission updated successfully to " + val + "%!");
                const currentCommission = document.getElementById('currentCommission');
                if (currentCommission) currentCommission.innerText = val + "%";
            }).catch(error => {
                alert("Error updating commission: " + error.message);
            });
        }

        async function fetchServicesFromAPI() {
            const catSelect = document.getElementById('catSelect');
            const srvSelect = document.getElementById('srvSelect');
            
            if (!catSelect || !srvSelect) return;
            
            const category = catSelect.value;
            
            if (!category) {
                srvSelect.innerHTML = '<option value="">Select a category first</option>';
                return;
            }
            
            srvSelect.innerHTML = '<option value="">Loading services...</option>';
            
            try {
                const res = await fetch(`${BACKEND_URL}/get-services?category=${encodeURIComponent(category)}`);
                const data = await res.json();
                
                if (!data || data.length === 0) {
                    srvSelect.innerHTML = '<option value="">No services found</option>';
                    return;
                }
                
                srvSelect.innerHTML = '<option value="">Choose Service ▼</option>';
                data.forEach(s => {
                    let apiPrice = parseFloat(s.price) || 0;
                    let finalPrice = apiPrice + (apiPrice * (globalComm / 100));
                    srvSelect.innerHTML += `<option value="${finalPrice}" data-id="${s.id}">${s.name} - ₹${finalPrice.toFixed(2)}/1k</option>`;
                });
                
                calculateAutoPrice();
            } catch (e) {
                console.error("Error fetching services:", e);
                srvSelect.innerHTML = '<option value="">Error loading services</option>';
            }
        }

        function calculateAutoPrice() {
            const srvSelect = document.getElementById('srvSelect');
            const orderQty = document.getElementById('orderQty');
            const totalPrice = document.getElementById('totalPrice');
            
            if (!srvSelect || !orderQty || !totalPrice) return;
            
            const pricePerK = parseFloat(srvSelect.value) || 0;
            const quantity = parseFloat(orderQty.value) || 0;
            const calculatedPrice = (pricePerK * (quantity / 1000)).toFixed(2);
            totalPrice.innerText = calculatedPrice;
        }

        function submitUTR() {
            const amtInp = document.getElementById('amtInp');
            const utrInp = document.getElementById('utrInp');
            const qrDiv = document.getElementById('qrDiv');
            
            if (!amtInp || !utrInp) return;
            
            const amt = amtInp.value;
            const utr = utrInp.value;
            
            if (!amt || amt <= 0) {
                alert("Please enter a valid amount!");
                return;
            }
            
            if (!utr || utr.trim().length < 8) {
                alert("Please enter a valid UTR/Transaction ID!");
                return;
            }
            
            const user = auth.currentUser;
            if (!user) return;
            
            db.ref('paymentRequests').push({
                uid: user.uid,
                email: user.email,
                amt: parseFloat(amt),
                utr: utr.trim(),
                status: 'pending',
                timestamp: Date.now(),
                name: user.displayName || 'User'
            }).then(() => {
                alert("UTR submitted successfully! Admin will approve it soon.");
                if (qrDiv) qrDiv.style.display = 'none';
                if (amtInp) amtInp.value = '';
                if (utrInp) utrInp.value = '';
            }).catch(error => {
                alert("Error submitting UTR: " + error.message);
            });
        }

        function loadOrders() {
            const user = auth.currentUser;
            if (!user) return;
            
            db.ref('orders/' + user.uid).limitToLast(10).on('value', snap => {
                const ordersList = document.getElementById('ordersList');
                if (!ordersList) return;
                
                let html = '';
                
                if (!snap.exists()) {
                    html = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--text-light);">No orders yet</td></tr>';
                } else {
                    snap.forEach(order => {
                        const data = order.val();
                        const date = new Date(data.timestamp || Date.now());
                        const statusClass = data.status === 'completed' ? 'status-completed' : 
                                           data.status === 'failed' ? 'status-failed' : 'status-pending';
                        
                        html += `
                            <tr>
                                <td>${order.key.substring(0, 8)}</td>
                                <td>${data.service || 'N/A'}</td>
                                <td>${data.quantity || 0}</td>
                                <td>₹${data.amount || '0.00'}</td>
                                <td class="${statusClass}">${data.status || 'pending'}</td>
                            </tr>
                        `;
                    });
                }
                
                ordersList.innerHTML = html;
            });
        }

        function loadRefillHistory() {
            const user = auth.currentUser;
            if (!user) return;
            
            db.ref('refills/' + user.uid).limitToLast(10).on('value', snap => {
                const refillList = document.getElementById('refillList');
                if (!refillList) return;
                
                let html = '';
                
                if (!snap.exists()) {
                    html = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--text-light);">No refill history</td></tr>';
                } else {
                    snap.forEach(refill => {
                        const data = refill.val();
                        const date = new Date(data.timestamp || Date.now());
                        const statusClass = data.status === 'completed' ? 'status-completed' : 
                                           data.status === 'failed' ? 'status-failed' : 'status-pending';
                        
                        html += `
                            <tr>
                                <td>${refill.key.substring(0, 8)}</td>
                                <td>${data.service || 'N/A'}</td>
                                <td>${date.toLocaleDateString()}</td>
                                <td class="${statusClass}">${data.status || 'pending'}</td>
                            </tr>
                        `;
                    });
                }
                
                refillList.innerHTML = html;
            });
        }

        async function loadAllServices() {
            try {
                const allServicesDiv = document.getElementById('allServices');
                if (!allServicesDiv) return;
                
                const res = await fetch(`${BACKEND_URL}/get-services`);
                const data = await res.json();
                
                if (!data || data.length === 0) {
                    allServicesDiv.innerHTML = '<p style="text-align: center; color: var(--text-light);">No services available</p>';
                    return;
                }
                
                // Group services by category
                const categories = {};
                data.forEach(service => {
                    if (!categories[service.category]) {
                        categories[service.category] = [];
                    }
                    let apiPrice = parseFloat(service.price) || 0;
                    let finalPrice = apiPrice + (apiPrice * (globalComm / 100));
                    categories[service.category].push({
                        name: service.name,
                        price: finalPrice.toFixed(2),
                        min: service.min || 100,
                        max: service.max || 10000
                    });
                });
                
                let html = '';
                for (const category in categories) {
                    html += `
                        <div style="margin-bottom: 25px;">
                            <h3 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid rgba(99, 102, 241, 0.3); padding-bottom: 5px;">${category}</h3>
                    `;
                    
                    categories[category].forEach(service => {
                        html += `
                            <div style="background: rgba(255, 255, 255, 0.03); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600;">${service.name}</div>
                                    <div style="font-size: 12px; color: var(--text-light);">Min: ${service.min} | Max: ${service.max}</div>
                                </div>
                                <div style="color: var(--accent); font-weight: 700;">₹${service.price}/1k</div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }
                
                allServicesDiv.innerHTML = html;
            } catch (error) {
                console.error("Error loading services:", error);
                const allServicesDiv = document.getElementById('allServices');
                if (allServicesDiv) {
                    allServicesDiv.innerHTML = '<p style="text-align: center; color: var(--danger);">Error loading services</p>';
                }
            }
        }

        function createTicket() {
            const ticketSubject = document.getElementById('ticketSubject');
            const ticketMessage = document.getElementById('ticketMessage');
            
            if (!ticketSubject || !ticketMessage) return;
            
            const subject = ticketSubject.value;
            const message = ticketMessage.value;
            
            if (!subject || !message) {
                alert("Please fill all fields!");
                return;
            }
            
            const user = auth.currentUser;
            if (!user) return;
            
            const ticketId = 'TICKET' + Date.now();
            db.ref('tickets/' + user.uid + '/' + ticketId).set({
                subject: subject,
                message: message,
                status: 'open',
                timestamp: Date.now(),
                email: user.email,
                name: user.displayName || 'User'
            }).then(() => {
                alert("Ticket created successfully!");
                ticketSubject.value = '';
                ticketMessage.value = '';
                loadTickets();
            }).catch(error => {
                alert("Error creating ticket: " + error.message);
            });
        }

        function loadTickets() {
            const user = auth.currentUser;
            if (!user) return;
            
            db.ref('tickets/' + user.uid).limitToLast(5).on('value', snap => {
                const ticketsList = document.getElementById('ticketsList');
                if (!ticketsList) return;
                
                let html = '';
                
                if (!snap.exists()) {
                    html = '<p style="text-align: center; color: var(--text-light); padding: 20px;">No tickets yet</p>';
                } else {
                    snap.forEach(ticket => {
                        const data = ticket.val();
                        const date = new Date(data.timestamp);
                        const statusClass = data.status === 'closed' ? 'status-completed' : 
                                           data.status === 'open' ? 'status-pending' : '';
                        
                        html += `
                            <div style="background: rgba(255, 255, 255, 0.03); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="font-weight: 600;">${data.subject}</div>
                                    <span class="${statusClass}" style="font-size: 12px;">${data.status || 'open'}</span>
                                </div>
                                <div style="color: var(--text-light); font-size: 14px; margin-bottom: 8px;">${data.message}</div>
                                <div style="font-size: 12px; color: var(--text-light);">${date.toLocaleString()}</div>
                            </div>
                        `;
                    });
                }
                
                ticketsList.innerHTML = html;
            });
        }

        function loadAPIKey() {
            const user = auth.currentUser;
            if (!user) return;
            
            db.ref('apiKeys/' + user.uid).once('value').then(snap => {
                const apiKeyDisplay = document.getElementById('apiKeyDisplay');
                if (!apiKeyDisplay) return;
                
                if (snap.exists()) {
                    apiKeyDisplay.innerText = snap.val().key || 'No API key found';
                } else {
                    apiKeyDisplay.innerText = 'No API key generated yet';
                }
            });
        }

        function generateAPIKey() {
            const user = auth.currentUser;
            if (!user) return;
            
            const apiKey = 'DG_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            
            db.ref('apiKeys/' + user.uid).set({
                key: apiKey,
                created: Date.now()
            }).then(() => {
                const apiKeyDisplay = document.getElementById('apiKeyDisplay');
                if (apiKeyDisplay) apiKeyDisplay.innerText = apiKey;
                alert("New API key generated successfully!");
            }).catch(error => {
                alert("Error generating API key: " + error.message);
            });
        }

        function loadReferralData() {
            const user = auth.currentUser;
            if (!user) return;
            
            // Generate referral code from user ID
            const referralCode = 'DG' + user.uid.substring(0, 8).toUpperCase();
            const referralLink = window.location.origin + window.location.pathname + '?ref=' + referralCode;
            
            const referralCodeEl = document.getElementById('referralCode');
            if (referralCodeEl) referralCodeEl.innerText = referralLink;
            
            // Load referral stats
            db.ref('referrals/' + user.uid).once('value').then(snap => {
                const data = snap.val() || { count: 0, earned: 0 };
                const refCount = document.getElementById('refCount');
                const refEarned = document.getElementById('refEarned');
                
                if (refCount) refCount.innerText = data.count || 0;
                if (refEarned) refEarned.innerText = '₹' + (data.earned || 0).toFixed(2);
            });
        }

        function copyReferralLink() {
            const referralCode = document.getElementById('referralCode');
            if (!referralCode) return;
            
            const referralLink = referralCode.innerText;
            navigator.clipboard.writeText(referralLink).then(() => {
                alert("Referral link copied to clipboard!");
            }).catch(err => {
                alert("Failed to copy: " + err);
            });
        }

        function openPage(pageId, element) {
            // Update pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            const pageElement = document.getElementById(pageId);
            if (pageElement) pageElement.classList.add('active');
            
            // Update sidebar items
            if (element) {
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                element.classList.add('active');
            }
            
            // Update bottom nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate corresponding bottom nav item
            const navItems = document.querySelectorAll('.nav-item');
            if (pageId === 'home' && navItems[0]) {
                navItems[0].classList.add('active');
            } else if (pageId === 'addfund' && navItems[1]) {
                navItems[1].classList.add('active');
            } else if (pageId === 'orders' && navItems[2]) {
                navItems[2].classList.add('active');
            } else if (pageId === 'support' && navItems[3]) {
                navItems[3].classList.add('active');
            }
            
            // Close sidebar on mobile
            toggleSidebar(false);
            
            // Refresh data for certain pages
            if (pageId === 'services') {
                loadAllServices();
            } else if (pageId === 'orders') {
                loadOrders();
            } else if (pageId === 'tickets') {
                loadTickets();
            } else if (pageId === 'admin') {
                loadAdminData();
            }
        }

        function toggleSidebar(show) {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return;
            
            if (show !== undefined) {
                sidebar.classList.toggle('active', show);
            } else {
                sidebar.classList.toggle('active');
            }
        }

        function doGoogleAuth() {
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
                .catch(error => {
                    alert("Google sign-in failed: " + error.message);
                });
        }

        function genQR() {
            const amtInp = document.getElementById('amtInp');
            if (!amtInp) return;
            
            const amount = amtInp.value;
            
            if (!amount || amount <= 0) {
                alert("Please enter a valid amount first!");
                return;
            }
            
            const upiId = "aqdaskhan03@fam";
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=upi://pay?pa=${encodeURIComponent(upiId)}&am=${amount}&cu=INR&tn=DG Social Service Payment`;
            
            const qrImg = document.getElementById('qrImg');
            const qrDiv = document.getElementById('qrDiv');
            
            if (qrImg) qrImg.src = qrUrl;
            if (qrDiv) qrDiv.style.display = 'block';
            
            // Scroll to QR
            if (qrDiv) {
                qrDiv.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function doLogout() {
            if (confirm("Are you sure you want to logout?")) {
                auth.signOut();
            }
        }

        function toggleAuth(isLogin) {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            
            if (loginForm) loginForm.style.display = isLogin ? 'block' : 'none';
            if (signupForm) signupForm.style.display = isLogin ? 'none' : 'block';
        }

        function doLogin() {
            const loginEmail = document.getElementById('loginEmail');
            const loginPass = document.getElementById('loginPass');
            
            if (!loginEmail || !loginPass) return;
            
            const email = loginEmail.value;
            const password = loginPass.value;
            
            if (!email || !password) {
                alert("Please enter both email and password!");
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    alert("Login failed: " + error.message);
                });
        }

        function doSignup() {
            const signupName = document.getElementById('signupName');
            const signupEmail = document.getElementById('signupEmail');
            const signupPass = document.getElementById('signupPass');
            
            if (!signupName || !signupEmail || !signupPass) return;
            
            const name = signupName.value;
            const email = signupEmail.value;
            const password = signupPass.value;
            
            if (!name || !email || !password) {
                alert("Please fill all fields!");
                return;
            }
            
            if (password.length < 6) {
                alert("Password must be at least 6 characters long!");
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then(result => {
                    // Update profile
                    return result.user.updateProfile({
                        displayName: name
                    }).then(() => {
                        // Create user in database
                        return db.ref('users/' + result.user.uid).set({
                            email: email,
                            name: name,
                            balance: 0,
                            status: 'active',
                            createdAt: Date.now()
                        });
                    });
                })
                .then(() => {
                    alert("Account created successfully! You are now logged in.");
                })
                .catch(error => {
                    alert("Signup failed: " + error.message);
                });
        }

        async function placeFinalOrder() {
            const srvSelect = document.getElementById('srvSelect');
            const orderLink = document.getElementById('orderLink');
            const orderQty = document.getElementById('orderQty');
            const totalPrice = document.getElementById('totalPrice');
            const orderBtn = document.getElementById('orderBtn');
            
            if (!srvSelect || !orderLink || !orderQty || !totalPrice || !orderBtn) return;
            
            const serviceId = srvSelect.options[srvSelect.selectedIndex]?.getAttribute('data-id');
            const link = orderLink.value;
            const qty = orderQty.value;
            const total = parseFloat(totalPrice.innerText);
            
            // Validation
            if (!serviceId) {
                alert("Please select a service!");
                return;
            }
            
            if (!link || link.trim().length < 3) {
                alert("Please enter a valid link or username!");
                return;
            }
            
            if (!qty || qty < 10) {
                alert("Quantity must be at least 10!");
                return;
            }
            
            if (total <= 0) {
                alert("Total price must be greater than 0!");
                return;
            }
            
            // Check balance
            const user = auth.currentUser;
            if (!user) return;
            
            const balanceSnap = await db.ref('users/' + user.uid + '/balance').once('value');
            const currentBal = balanceSnap.val() || 0;
            
            if (currentBal < total) {
                alert(`Insufficient balance! You need ₹${total.toFixed(2)} but have only ₹${currentBal.toFixed(2)}`);
                return;
            }
            
            // Confirm order
            if (!confirm(`Confirm order for ₹${total.toFixed(2)}?`)) return;
            
            // Update button
            const originalText = orderBtn.innerHTML;
            orderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            orderBtn.disabled = true;
            
            try {
                // Place order with backend
                const res = await fetch(`${BACKEND_URL}/place-order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        service: serviceId, 
                        link: link.trim(), 
                        quantity: qty 
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    // Deduct balance
                    await db.ref('users/' + user.uid + '/balance').set(currentBal - total);
                    
                    // Save order to user's orders
                    const orderId = 'ORDER' + Date.now();
                    await db.ref('orders/' + user.uid + '/' + orderId).set({
                        service: serviceId,
                        link: link,
                        quantity: qty,
                        amount: total,
                        status: 'pending',
                        timestamp: Date.now()
                    });
                    
                    // Show success
                    alert(`Order placed successfully!\nOrder ID: ${data.orderId || orderId}\nAmount: ₹${total.toFixed(2)}\nRemaining Balance: ₹${(currentBal - total).toFixed(2)}`);
                    
                    // Reset form
                    orderLink.value = '';
                    totalPrice.innerText = '0.00';
                    
                } else {
                    alert("Order Error: " + (data.message || "Unknown error"));
                }
                
            } catch (error) {
                console.error("Order error:", error);
                alert("Failed to place order. Please try again later.");
            } finally {
                // Reset button
                orderBtn.innerHTML = originalText;
                orderBtn.disabled = false;
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            // Add click outside sidebar to close
            document.addEventListener('click', function(event) {
                const sidebar = document.getElementById('sidebar');
                const menuToggle = document.querySelector('.menu-toggle');
                
                if (sidebar && menuToggle && sidebar.classList.contains('active') && 
                    !sidebar.contains(event.target) && 
                    !menuToggle.contains(event.target)) {
                    sidebar.classList.remove('active');
                }
            });
            
            // Close sidebar when clicking on a menu item (for mobile)
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        toggleSidebar(false);
                    }
                });
            });
            
            // Check for referral parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode && !auth.currentUser) {
                localStorage.setItem('referralCode', refCode);
            }
            
            // Load saved customizations
            const savedTheme = localStorage.getItem('dg_theme');
            const savedLogo = localStorage.getItem('dg_logo_text');
            const savedColor = localStorage.getItem('dg_primary_color');
            
            if (savedTheme) {
                // Apply saved theme
            }
            
            if (savedLogo) {
                document.querySelectorAll('.logo span, .sidebar-title').forEach(el => {
                    el.textContent = savedLogo;
                });
            }
            
            if (savedColor) {
                document.documentElement.style.setProperty('--primary', savedColor);
                document.documentElement.style.setProperty('--primary-dark', darkenColor(savedColor, 20));
            }
        });

        // ============================
        // GLOBAL EXPORTS
        // ============================
        window.updateComm = updateComm;
        window.fetchServicesFromAPI = fetchServicesFromAPI;
        window.calculateAutoPrice = calculateAutoPrice;
        window.submitUTR = submitUTR;
        window.createTicket = createTicket;
        window.generateAPIKey = generateAPIKey;
        window.copyReferralLink = copyReferralLink;
        window.openPage = openPage;
        window.toggleSidebar = toggleSidebar;
        window.doGoogleAuth = doGoogleAuth;
        window.genQR = genQR;
        window.doLogout = doLogout;
        window.toggleAuth = toggleAuth;
        window.doLogin = doLogin;
        window.doSignup = doSignup;
        window.placeFinalOrder = placeFinalOrder;
        window.openAdminTab = openAdminTab;
        window.showAddServiceModal = showAddServiceModal;
        window.closeModal = closeModal;
        window.addNewService = addNewService;
        window.showAddMenuModal = showAddMenuModal;
        window.addNewMenuItem = addNewMenuItem;
    </script>
</body>
</html>
